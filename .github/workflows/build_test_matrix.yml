name: Build & Test Matrix

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:

    strategy:
      fail-fast: false
      matrix:
        config:
        - {os: ubuntu-latest, name: Linux}
        - {os: macos-latest, name: MacOS}

    runs-on: ${{ matrix.config.os }}
    name: Build & Test - ${{ matrix.config.name }} 
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Platform Setup
      run: |
        if [[ "${{ matrix.config.os }}" == "macos-latest" ]]; then
          echo "Setting up Docker for macOS..."
          brew install --cask docker
          open /Applications/Docker.app
          sleep 10 # Wait for Docker to initialize
        elif [[ "${{ matrix.config.os }}" == "ubuntu-latest" ]]; then
          echo "Starting Docker on Ubuntu..."
          sudo service docker start
        fi

    - name: Docker Versions
      run: |
        docker --version
        docker-compose --version

    - name: Compose Build
      run: docker-compose build --no-cache 2>&1 | tee compose-build.log
    - name: Upload Build Logs
      uses: actions/upload-artifact@v3
      with:
        name: compose-build-log-${{ matrix.config.os }}
        path: compose-build.log

    - name: Compose Up
      run: docker-compose up -d 2>&1 | tee compose-up.log
    - name: Upload Compose Up Logs
      uses: actions/upload-artifact@v3
      with:
        name: compose-up-${{ matrix.config.os }}.log
        path: compose-up.log

    - name: Health Check Test
      run: |
        docker-compose ps
        health_response=$(curl -s http://localhost:8080/health)
        echo "Health Check Response: $health_response"
        echo "$health_response" | jq '.status' | grep -q '"up"' || exit 1

    - name: Compose Logs Test
      run: |
        docker-compose logs 2>&1 | tee compose-run.log
        grep compose-run.log "Configuration complete; ready for start up" || exit 1
    - name: Upload Compose Run Logs
      uses: actions/upload-artifact@v3
      with:
        name: compose-run-${{ matrix.config.os }}.log
        path: compose-run.log

    - name: Compose Down
      run: docker-compose down 2>&1 | tee compose-down.log
    - name: Upload Compose Down Logs
      uses: actions/upload-artifact@v3
      with:
        name: compose-down-${{ matrix.config.os }}.log
        path: compose-down.log