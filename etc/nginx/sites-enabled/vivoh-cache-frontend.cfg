
upstream cache {
   server unix:/var/run/nginx-frontend.sock;
   keepalive 128;
}

perl_modules /var/lib/nginx/perl/lib;
perl_require VivohCache/Admin.pm;

log_format  custom  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" "$http_x_real_ip"';
server {
    listen 443 ssl http2 default;
    server_name vivoh-cache.home.marzot.net localhost;

	ssl_certificate     /etc/nginx/pki/star.home.marzot.net.crt;
    ssl_certificate_key /etc/nginx/pki/star.home.marzot.net.key;

    access_log /var/log/nginx/vivoh-cache-frontend-access.log custom buffer=32k flush=3s;
    error_log /var/log/nginx/vivoh-cache-frontend-error.log;

    location ~ /cache/([^/]*)/(.*) {
       proxy_http_version 1.1;
	   proxy_set_header   "Connection" "";
       proxy_pass "http://cache/$2$is_args$args";
       proxy_set_header X-Real-IP  $remote_addr;
       proxy_set_header X-Forwarded-Proto https;
       proxy_set_header X-Forwarded-Port 443;
       proxy_set_header Host $1;
    }

    location /admin/ {
	   perl VivohCache::Admin::handler;
    }
}

server {
    listen 443 ssl http2;
    server_name ontime.demo.vivoh.com;

    ssl_certificate     /etc/nginx/pki/star.demo.vivoh.com.pem;
    ssl_certificate_key /etc/nginx/pki/star.demo.vivoh.com.key;

    access_log /var/log/nginx/ontime-vivoh-cache-frontend-access.log custom buffer=32k flush=3s;
    error_log /var/log/nginx/ontime-vivoh-cache-frontend-error.log;

    location ~ /(.*) {
       proxy_http_version 1.1;
       proxy_set_header   "Connection" "";
       proxy_pass "http://cache/$1$is_args$args";
       proxy_set_header X-Real-IP  $remote_addr;
       proxy_set_header X-Forwarded-Proto https;
       proxy_set_header X-Forwarded-Port 443;
       proxy_set_header Host ontime.demo.vivoh.com;
    }

    location /admin/ {
       perl VivohCache::Admin::handler;
    }
}

