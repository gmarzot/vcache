version: "3"
services:
  frontend:
    restart: always
    image: nginx-perl
    build:
      context: nginx
    container_name: frontend
    volumes:
      - "./run:/var/run"
      - "./log/nginx:/var/log/nginx"
      - "./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./etc/nginx/pki:/etc/nginx/pki:ro"
      - "./etc/nginx/sites-enabled/vivoh-cache-frontend.cfg:/etc/nginx/sites-enabled/vivoh-cache-frontend.cfg"
      - "./etc/nginx/modules-enabled/80-mod-http-perl.conf:/etc/nginx/modules-enabled/80-mod-http-perl.conf"
      - "./nginx/perl:/var/lib/nginx/perl"
    ports:
      - "443:443"
    ulimits:
       nofile:
         soft: 262144
         hard: 262144
    depends_on:
      - cache

  stats:
    restart: always
    build:
      context: varnish
    container_name: stats
    ports:
      - "9131:9131"
    mem_limit: 100m
    environment:
      VSM_NOPID: 1
    depends_on:
      - cache
    volumes:
      - ./src:/etc/varnish:ro
      - varnish_tmpfs:/var/lib/varnish:ro
    command: prometheus_varnish_exporter

  cache:
    restart: always
    image: varnish
    build:
      context: varnish
    container_name: cache
    ports:
      - "6085:6085"
    volumes:
      - "./etc/varnish:/etc/varnish"
      - "./run:/var/run"
      - "varnish_tmpfs:/var/lib/varnish"
    environment:
      - VARNISH_SIZE=12G
    command:
      - "-a /var/run/nginx-frontend.sock,HTTP,user=varnish,group=varnish,mode=666"
    depends_on:
      - backend

  backend:
    restart: always
    image: nginx-perl
    build:
      context: nginx
    container_name: backend
    volumes:
      - "./run:/var/run"
      - "./log/nginx:/var/log/nginx"
      - "./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./etc/nginx/pki:/etc/nginx/pki:ro"
      - "./etc/nginx/sites-enabled/vivoh-cache-backend.cfg:/etc/nginx/sites-enabled/vivoh-cache-backend.cfg"
      - "./etc/nginx/modules-enabled/80-mod-http-perl.conf:/etc/nginx/modules-enabled/80-mod-http-perl.conf"
      - "./nginx/perl:/var/lib/nginx/perl"
    network_mode: "host"

volumes:
  varnish_tmpfs:
    driver_opts:
      type: tmpfs
      device: tmpfs
